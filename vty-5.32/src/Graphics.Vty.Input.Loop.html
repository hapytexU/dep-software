<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# OPTIONS_HADDOCK hide #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE NoMonomorphismRestriction #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- | The input layer used to be a single function that correctly</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- accounted for the non-threaded runtime by emulating the terminal</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- VMIN adn VTIME handling. This has been removed and replace with a</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- more straightforward parser. The non-threaded runtime is no longer</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- supported.</span><span>
</span><span id="line-11"></span><span class="hs-comment">--</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- This is an example of an algorithm where code coverage could be high,</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- even 100%, but the behavior is still under tested. I should collect</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- more of these examples...</span><span>
</span><span id="line-15"></span><span class="hs-comment">--</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- reference: http://www.unixwiz.net/techtips/termios-vmin-vtime.html</span><span>
</span><span id="line-17"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Graphics.Vty.Input.Loop</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Graphics.Vty.Config.html"><span class="hs-identifier">Graphics.Vty.Config</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Classify.html"><span class="hs-identifier">Graphics.Vty.Input.Classify</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Events.html"><span class="hs-identifier">Graphics.Vty.Input.Events</span></a></span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mask</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">try</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">SomeException</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Lens.Micro</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(&lt;&gt;~)</span></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Lens.Micro.Mtl</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Lens.Micro.TH</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">when</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mzero</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">forM_</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">liftIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.State</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">StateT</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">evalStateT</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadState</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">modify</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Reader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ReaderT</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Char</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Word8</span></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Foreign</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">allocaArray</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">peekArray</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Ptr</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Foreign.C.Types</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">CInt</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Posix.IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fdReadBuf</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">setFdOption</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">FdOption</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Posix.Terminal</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Posix.Types</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Fd</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Text.Printf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">hPrintf</span></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-keyword">data</span><span> </span><span id="Input"><span class="annot"><a href="Graphics.Vty.Input.Loop.html#Input"><span class="hs-identifier hs-var">Input</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Input"><span class="annot"><a href="Graphics.Vty.Input.Loop.html#Input"><span class="hs-identifier hs-var">Input</span></a></span></span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | Channel of events direct from input processing. Unlike</span><span>
</span><span id="line-52"></span><span>      </span><span class="hs-comment">-- 'nextEvent' this will not refresh the display if the next event</span><span>
</span><span id="line-53"></span><span>      </span><span class="hs-comment">-- is an 'EvResize'.</span><span>
</span><span id="line-54"></span><span>      </span><span id="_eventChannel"><span class="annot"><span class="annottext">Input -&gt; TChan Event
</span><a href="Graphics.Vty.Input.Loop.html#_eventChannel"><span class="hs-identifier hs-var hs-var">_eventChannel</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TChan</span></span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Events.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span>
</span><span id="line-55"></span><span>      </span><span class="hs-comment">-- | Shuts down the input processing. As part of shutting down the</span><span>
</span><span id="line-56"></span><span>      </span><span class="hs-comment">-- input, this should also restore the input state.</span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="shutdownInput"><span class="annot"><span class="annottext">Input -&gt; IO ()
</span><a href="Graphics.Vty.Input.Loop.html#shutdownInput"><span class="hs-identifier hs-var hs-var">shutdownInput</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span>      </span><span class="hs-comment">-- | Restore the terminal's input state to what it was prior</span><span>
</span><span id="line-59"></span><span>      </span><span class="hs-comment">-- to configuring input for Vty. This should be done as part of</span><span>
</span><span id="line-60"></span><span>      </span><span class="hs-comment">-- 'shutdownInput' but is exposed in case you need to access it</span><span>
</span><span id="line-61"></span><span>      </span><span class="hs-comment">-- directly.</span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="restoreInputState"><span class="annot"><span class="annottext">Input -&gt; IO ()
</span><a href="Graphics.Vty.Input.Loop.html#restoreInputState"><span class="hs-identifier hs-var hs-var">restoreInputState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>      </span><span class="hs-comment">-- | Changes to this value are reflected after the next event.</span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_configRef"><span class="annot"><span class="annottext">Input -&gt; IORef Config
</span><a href="Graphics.Vty.Input.Loop.html#_configRef"><span class="hs-identifier hs-var hs-var">_configRef</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><a href="Graphics.Vty.Config.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span>
</span><span id="line-65"></span><span>      </span><span class="hs-comment">-- | input debug log</span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_inputDebug"><span class="annot"><span class="annottext">Input -&gt; Maybe Handle
</span><a href="Graphics.Vty.Input.Loop.html#_inputDebug"><span class="hs-identifier hs-var hs-var">_inputDebug</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span id="inputDebug"><span id="eventChannel"><span id="configRef"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Input</span></span></span></span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-keyword">data</span><span> </span><span id="InputBuffer"><span class="annot"><a href="Graphics.Vty.Input.Loop.html#InputBuffer"><span class="hs-identifier hs-var">InputBuffer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="InputBuffer"><span class="annot"><a href="Graphics.Vty.Input.Loop.html#InputBuffer"><span class="hs-identifier hs-var">InputBuffer</span></a></span></span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="_ptr"><span class="annot"><span class="annottext">InputBuffer -&gt; Ptr Word8
</span><a href="Graphics.Vty.Input.Loop.html#_ptr"><span class="hs-identifier hs-var hs-var">_ptr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_size"><span class="annot"><span class="annottext">InputBuffer -&gt; Int
</span><a href="Graphics.Vty.Input.Loop.html#_size"><span class="hs-identifier hs-var hs-var">_size</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span id="size"><span id="ptr"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">InputBuffer</span></span></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span class="hs-keyword">data</span><span> </span><span id="InputState"><span class="annot"><a href="Graphics.Vty.Input.Loop.html#InputState"><span class="hs-identifier hs-var">InputState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="InputState"><span class="annot"><a href="Graphics.Vty.Input.Loop.html#InputState"><span class="hs-identifier hs-var">InputState</span></a></span></span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="_unprocessedBytes"><span class="annot"><span class="annottext">InputState -&gt; String
</span><a href="Graphics.Vty.Input.Loop.html#_unprocessedBytes"><span class="hs-identifier hs-var hs-var">_unprocessedBytes</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_appliedConfig"><span class="annot"><span class="annottext">InputState -&gt; Config
</span><a href="Graphics.Vty.Input.Loop.html#_appliedConfig"><span class="hs-identifier hs-var hs-var">_appliedConfig</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Graphics.Vty.Config.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_inputBuffer"><span class="annot"><span class="annottext">InputState -&gt; InputBuffer
</span><a href="Graphics.Vty.Input.Loop.html#_inputBuffer"><span class="hs-identifier hs-var hs-var">_inputBuffer</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#InputBuffer"><span class="hs-identifier hs-type">InputBuffer</span></a></span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_classifier"><span class="annot"><span class="annottext">InputState -&gt; String -&gt; KClass
</span><a href="Graphics.Vty.Input.Loop.html#_classifier"><span class="hs-identifier hs-var hs-var">_classifier</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Classify.Types.html#KClass"><span class="hs-identifier hs-type">KClass</span></a></span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span id="unprocessedBytes"><span id="inputBuffer"><span id="classifier"><span id="appliedConfig"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">InputState</span></span></span></span></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-keyword">type</span><span> </span><span id="InputM"><span class="annot"><a href="Graphics.Vty.Input.Loop.html#InputM"><span class="hs-identifier hs-var">InputM</span></a></span></span><span> </span><span id="local-6989586621679366880"><span class="annot"><a href="#local-6989586621679366880"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#InputState"><span class="hs-identifier hs-type">InputState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#Input"><span class="hs-identifier hs-type">Input</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679366880"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#logMsg"><span class="hs-identifier hs-type">logMsg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#InputM"><span class="hs-identifier hs-type">InputM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span id="logMsg"><span class="annot"><span class="annottext">logMsg :: String -&gt; InputM ()
</span><a href="Graphics.Vty.Input.Loop.html#logMsg"><span class="hs-identifier hs-var hs-var">logMsg</span></a></span></span><span> </span><span id="local-6989586621679366878"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366878"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-91"></span><span>    </span><span id="local-6989586621679366877"><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679366877"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Getting (Maybe Handle) Input (Maybe Handle)
-&gt; StateT InputState (ReaderT Input IO) (Maybe Handle)
forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">view</span></span><span> </span><span class="annot"><span class="annottext">Getting (Maybe Handle) Input (Maybe Handle)
Lens' Input (Maybe Handle)
</span><a href="Graphics.Vty.Input.Loop.html#inputDebug"><span class="hs-identifier hs-var">inputDebug</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679366877"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-93"></span><span>        </span><span class="annot"><span class="annottext">Maybe Handle
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; InputM ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679366875"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679366875"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; InputM ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; InputM ()) -&gt; IO () -&gt; InputM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; String -&gt; IO ()
</span><span class="hs-identifier hs-var">hPutStrLn</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679366875"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366878"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; IO ()
</span><span class="hs-identifier hs-var">hFlush</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679366875"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-comment">-- this must be run on an OS thread dedicated to this input handling.</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- otherwise the terminal timing read behavior will block the execution</span><span>
</span><span id="line-98"></span><span class="hs-comment">-- of the lightweight threads.</span><span>
</span><span id="line-99"></span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#loopInputProcessor"><span class="hs-identifier hs-type">loopInputProcessor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#InputM"><span class="hs-identifier hs-type">InputM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span id="loopInputProcessor"><span class="annot"><span class="annottext">loopInputProcessor :: InputM ()
</span><a href="Graphics.Vty.Input.Loop.html#loopInputProcessor"><span class="hs-identifier hs-var hs-var">loopInputProcessor</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-101"></span><span>    </span><span class="annot"><span class="annottext">InputM String
</span><a href="Graphics.Vty.Input.Loop.html#readFromDevice"><span class="hs-identifier hs-var">readFromDevice</span></a></span><span> </span><span class="annot"><span class="annottext">InputM String -&gt; (String -&gt; InputM ()) -&gt; InputM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; InputM ()
</span><a href="Graphics.Vty.Input.Loop.html#addBytesToProcess"><span class="hs-identifier hs-var">addBytesToProcess</span></a></span><span>
</span><span id="line-102"></span><span>    </span><span id="local-6989586621679366869"><span class="annot"><span class="annottext">[Event]
</span><a href="#local-6989586621679366869"><span class="hs-identifier hs-var">validEvents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT InputState (ReaderT Input IO) Event
-&gt; StateT InputState (ReaderT Input IO) [Event]
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f [a]
</span><span class="hs-identifier hs-var">many</span></span><span> </span><span class="annot"><span class="annottext">StateT InputState (ReaderT Input IO) Event
</span><a href="Graphics.Vty.Input.Loop.html#parseEvent"><span class="hs-identifier hs-var">parseEvent</span></a></span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><span class="annottext">[Event] -&gt; (Event -&gt; InputM ()) -&gt; InputM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[Event]
</span><a href="#local-6989586621679366869"><span class="hs-identifier hs-var">validEvents</span></a></span><span> </span><span class="annot"><span class="annottext">Event -&gt; InputM ()
</span><a href="Graphics.Vty.Input.Loop.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><span class="annottext">InputM ()
</span><a href="Graphics.Vty.Input.Loop.html#dropInvalid"><span class="hs-identifier hs-var">dropInvalid</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><span class="annottext">InputM ()
</span><a href="Graphics.Vty.Input.Loop.html#loopInputProcessor"><span class="hs-identifier hs-var">loopInputProcessor</span></a></span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#addBytesToProcess"><span class="hs-identifier hs-type">addBytesToProcess</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#InputM"><span class="hs-identifier hs-type">InputM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span id="addBytesToProcess"><span class="annot"><span class="annottext">addBytesToProcess :: String -&gt; InputM ()
</span><a href="Graphics.Vty.Input.Loop.html#addBytesToProcess"><span class="hs-identifier hs-var hs-var">addBytesToProcess</span></a></span></span><span> </span><span id="local-6989586621679366864"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366864"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String -&gt; Identity String) -&gt; InputState -&gt; Identity InputState
Lens' InputState String
</span><a href="Graphics.Vty.Input.Loop.html#unprocessedBytes"><span class="hs-identifier hs-var">unprocessedBytes</span></a></span><span> </span><span class="annot"><span class="annottext">((String -&gt; Identity String) -&gt; InputState -&gt; Identity InputState)
-&gt; String -&gt; InputM ()
forall s (m :: * -&gt; *) a.
(MonadState s m, Monoid a) =&gt;
ASetter' s a -&gt; a -&gt; m ()
</span><a href="Graphics.Vty.Input.Loop.html#%3C%3E%3D"><span class="hs-operator hs-var">&lt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366864"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#emit"><span class="hs-identifier hs-type">emit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Events.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#InputM"><span class="hs-identifier hs-type">InputM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span id="emit"><span class="annot"><span class="annottext">emit :: Event -&gt; InputM ()
</span><a href="Graphics.Vty.Input.Loop.html#emit"><span class="hs-identifier hs-var hs-var">emit</span></a></span></span><span> </span><span id="local-6989586621679366862"><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679366862"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; InputM ()
</span><a href="Graphics.Vty.Input.Loop.html#logMsg"><span class="hs-identifier hs-var">logMsg</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; InputM ()) -&gt; String -&gt; InputM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;parsed event: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Event -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679366862"><span class="hs-identifier hs-var">event</span></a></span><span>
</span><span id="line-113"></span><span>    </span><span class="annot"><span class="annottext">Getting (TChan Event) Input (TChan Event)
-&gt; StateT InputState (ReaderT Input IO) (TChan Event)
forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">view</span></span><span> </span><span class="annot"><span class="annottext">Getting (TChan Event) Input (TChan Event)
Lens' Input (TChan Event)
</span><a href="Graphics.Vty.Input.Loop.html#eventChannel"><span class="hs-identifier hs-var">eventChannel</span></a></span><span> </span><span class="annot"><span class="annottext">StateT InputState (ReaderT Input IO) (TChan Event)
-&gt; (TChan Event -&gt; InputM ()) -&gt; InputM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; InputM ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; InputM ())
-&gt; (TChan Event -&gt; IO ()) -&gt; TChan Event -&gt; InputM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ())
-&gt; (TChan Event -&gt; STM ()) -&gt; TChan Event -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TChan Event -&gt; Event -&gt; STM ()) -&gt; Event -&gt; TChan Event -&gt; STM ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">TChan Event -&gt; Event -&gt; STM ()
forall a. TChan a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTChan</span></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679366862"><span class="hs-identifier hs-var">event</span></a></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="hs-comment">-- The timing requirements are assured by the VMIN and VTIME set for the</span><span>
</span><span id="line-116"></span><span class="hs-comment">-- device.</span><span>
</span><span id="line-117"></span><span class="hs-comment">--</span><span>
</span><span id="line-118"></span><span class="hs-comment">-- Precondition: Under the threaded runtime. Only current use is from a</span><span>
</span><span id="line-119"></span><span class="hs-comment">-- forkOS thread. That case satisfies precondition.</span><span>
</span><span id="line-120"></span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#readFromDevice"><span class="hs-identifier hs-type">readFromDevice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#InputM"><span class="hs-identifier hs-type">InputM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-121"></span><span id="readFromDevice"><span class="annot"><span class="annottext">readFromDevice :: InputM String
</span><a href="Graphics.Vty.Input.Loop.html#readFromDevice"><span class="hs-identifier hs-var hs-var">readFromDevice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-122"></span><span>    </span><span id="local-6989586621679366856"><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679366856"><span class="hs-identifier hs-var">newConfig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Getting (IORef Config) Input (IORef Config)
-&gt; StateT InputState (ReaderT Input IO) (IORef Config)
forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">view</span></span><span> </span><span class="annot"><span class="annottext">Getting (IORef Config) Input (IORef Config)
Lens' Input (IORef Config)
</span><a href="Graphics.Vty.Input.Loop.html#configRef"><span class="hs-identifier hs-var">configRef</span></a></span><span> </span><span class="annot"><span class="annottext">StateT InputState (ReaderT Input IO) (IORef Config)
-&gt; (IORef Config -&gt; StateT InputState (ReaderT Input IO) Config)
-&gt; StateT InputState (ReaderT Input IO) Config
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">IO Config -&gt; StateT InputState (ReaderT Input IO) Config
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Config -&gt; StateT InputState (ReaderT Input IO) Config)
-&gt; (IORef Config -&gt; IO Config)
-&gt; IORef Config
-&gt; StateT InputState (ReaderT Input IO) Config
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IORef Config -&gt; IO Config
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span>
</span><span id="line-123"></span><span>    </span><span id="local-6989586621679366854"><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679366854"><span class="hs-identifier hs-var">oldConfig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Getting Config InputState Config
-&gt; StateT InputState (ReaderT Input IO) Config
forall s (m :: * -&gt; *) a. MonadState s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">use</span></span><span> </span><span class="annot"><span class="annottext">Getting Config InputState Config
Lens' InputState Config
</span><a href="Graphics.Vty.Input.Loop.html#appliedConfig"><span class="hs-identifier hs-var">appliedConfig</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679366852"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679366852"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config -&gt; Maybe Fd
</span><a href="Graphics.Vty.Config.html#inputFd"><span class="hs-identifier hs-var hs-var">inputFd</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679366856"><span class="hs-identifier hs-var">newConfig</span></a></span><span>
</span><span id="line-125"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; InputM () -&gt; InputM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679366856"><span class="hs-identifier hs-var">newConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Config -&gt; Config -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679366854"><span class="hs-identifier hs-var">oldConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InputM () -&gt; InputM ()) -&gt; InputM () -&gt; InputM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-126"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; InputM ()
</span><a href="Graphics.Vty.Input.Loop.html#logMsg"><span class="hs-identifier hs-var">logMsg</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; InputM ()) -&gt; String -&gt; InputM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;new config: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Config -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679366856"><span class="hs-identifier hs-var">newConfig</span></a></span><span>
</span><span id="line-127"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; InputM ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; InputM ()) -&gt; IO () -&gt; InputM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fd -&gt; Config -&gt; IO ()
</span><a href="Graphics.Vty.Input.Loop.html#applyConfig"><span class="hs-identifier hs-var">applyConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679366852"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679366856"><span class="hs-identifier hs-var">newConfig</span></a></span><span>
</span><span id="line-128"></span><span>        </span><span class="annot"><span class="annottext">(Config -&gt; Identity Config) -&gt; InputState -&gt; Identity InputState
Lens' InputState Config
</span><a href="Graphics.Vty.Input.Loop.html#appliedConfig"><span class="hs-identifier hs-var">appliedConfig</span></a></span><span> </span><span class="annot"><span class="annottext">((Config -&gt; Identity Config) -&gt; InputState -&gt; Identity InputState)
-&gt; Config -&gt; InputM ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679366856"><span class="hs-identifier hs-var">newConfig</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span id="local-6989586621679366847"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679366847"><span class="hs-identifier hs-var">bufferPtr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Getting (Ptr Word8) InputState (Ptr Word8)
-&gt; StateT InputState (ReaderT Input IO) (Ptr Word8)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">use</span></span><span> </span><span class="annot"><span class="annottext">(Getting (Ptr Word8) InputState (Ptr Word8)
 -&gt; StateT InputState (ReaderT Input IO) (Ptr Word8))
-&gt; Getting (Ptr Word8) InputState (Ptr Word8)
-&gt; StateT InputState (ReaderT Input IO) (Ptr Word8)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(InputBuffer -&gt; Const (Ptr Word8) InputBuffer)
-&gt; InputState -&gt; Const (Ptr Word8) InputState
Lens' InputState InputBuffer
</span><a href="Graphics.Vty.Input.Loop.html#inputBuffer"><span class="hs-identifier hs-var">inputBuffer</span></a></span><span class="annot"><span class="annottext">((InputBuffer -&gt; Const (Ptr Word8) InputBuffer)
 -&gt; InputState -&gt; Const (Ptr Word8) InputState)
-&gt; ((Ptr Word8 -&gt; Const (Ptr Word8) (Ptr Word8))
    -&gt; InputBuffer -&gt; Const (Ptr Word8) InputBuffer)
-&gt; Getting (Ptr Word8) InputState (Ptr Word8)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span class="annot"><span class="annottext">(Ptr Word8 -&gt; Const (Ptr Word8) (Ptr Word8))
-&gt; InputBuffer -&gt; Const (Ptr Word8) InputBuffer
Lens' InputBuffer (Ptr Word8)
</span><a href="Graphics.Vty.Input.Loop.html#ptr"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-130"></span><span>    </span><span id="local-6989586621679366846"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679366846"><span class="hs-identifier hs-var">maxBytes</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Getting Int InputState Int
-&gt; StateT InputState (ReaderT Input IO) Int
forall s (m :: * -&gt; *) a. MonadState s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">use</span></span><span> </span><span class="annot"><span class="annottext">(Getting Int InputState Int
 -&gt; StateT InputState (ReaderT Input IO) Int)
-&gt; Getting Int InputState Int
-&gt; StateT InputState (ReaderT Input IO) Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(InputBuffer -&gt; Const Int InputBuffer)
-&gt; InputState -&gt; Const Int InputState
Lens' InputState InputBuffer
</span><a href="Graphics.Vty.Input.Loop.html#inputBuffer"><span class="hs-identifier hs-var">inputBuffer</span></a></span><span class="annot"><span class="annottext">((InputBuffer -&gt; Const Int InputBuffer)
 -&gt; InputState -&gt; Const Int InputState)
-&gt; ((Int -&gt; Const Int Int) -&gt; InputBuffer -&gt; Const Int InputBuffer)
-&gt; Getting Int InputState Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span class="annot"><span class="annottext">(Int -&gt; Const Int Int) -&gt; InputBuffer -&gt; Const Int InputBuffer
Lens' InputBuffer Int
</span><a href="Graphics.Vty.Input.Loop.html#size"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-131"></span><span>    </span><span id="local-6989586621679366845"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366845"><span class="hs-identifier hs-var">stringRep</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO String -&gt; InputM String
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO String -&gt; InputM String) -&gt; IO String -&gt; InputM String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-132"></span><span>        </span><span class="hs-comment">-- The killThread used in shutdownInput will not interrupt the</span><span>
</span><span id="line-133"></span><span>        </span><span class="hs-comment">-- foreign call fdReadBuf uses this provides a location to be</span><span>
</span><span id="line-134"></span><span>        </span><span class="hs-comment">-- interrupted prior to the foreign call. If there is input on</span><span>
</span><span id="line-135"></span><span>        </span><span class="hs-comment">-- the FD then the fdReadBuf will return in a finite amount of</span><span>
</span><span id="line-136"></span><span>        </span><span class="hs-comment">-- time due to the vtime terminal setting.</span><span>
</span><span id="line-137"></span><span>        </span><span class="annot"><span class="annottext">Fd -&gt; IO ()
</span><span class="hs-identifier hs-var">threadWaitRead</span></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679366852"><span class="hs-identifier hs-var">fd</span></a></span><span>
</span><span id="line-138"></span><span>        </span><span id="local-6989586621679366843"><span class="annot"><span class="annottext">ByteCount
</span><a href="#local-6989586621679366843"><span class="hs-identifier hs-var">bytesRead</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Fd -&gt; Ptr Word8 -&gt; ByteCount -&gt; IO ByteCount
</span><span class="hs-identifier hs-var">fdReadBuf</span></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679366852"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679366847"><span class="hs-identifier hs-var">bufferPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; ByteCount
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679366846"><span class="hs-identifier hs-var">maxBytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteCount
</span><a href="#local-6989586621679366843"><span class="hs-identifier hs-var">bytesRead</span></a></span><span> </span><span class="annot"><span class="annottext">ByteCount -&gt; ByteCount -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">ByteCount
</span><span class="hs-number">0</span></span><span>
</span><span id="line-140"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">([Word8] -&gt; String) -&gt; IO [Word8] -&gt; IO String
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Word8 -&gt; Char) -&gt; [Word8] -&gt; String
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">((Word8 -&gt; Char) -&gt; [Word8] -&gt; String)
-&gt; (Word8 -&gt; Char) -&gt; [Word8] -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Char
</span><span class="hs-identifier hs-var">chr</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Char) -&gt; (Word8 -&gt; Int) -&gt; Word8 -&gt; Char
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO [Word8] -&gt; IO String) -&gt; IO [Word8] -&gt; IO String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Ptr Word8 -&gt; IO [Word8]
forall a. Storable a =&gt; Int -&gt; Ptr a -&gt; IO [a]
</span><span class="hs-identifier hs-var">peekArray</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteCount -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">ByteCount
</span><a href="#local-6989586621679366843"><span class="hs-identifier hs-var">bytesRead</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679366847"><span class="hs-identifier hs-var">bufferPtr</span></a></span><span>
</span><span id="line-141"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO String
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-142"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; InputM () -&gt; InputM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366845"><span class="hs-identifier hs-var">stringRep</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InputM () -&gt; InputM ()) -&gt; InputM () -&gt; InputM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; InputM ()
</span><a href="Graphics.Vty.Input.Loop.html#logMsg"><span class="hs-identifier hs-var">logMsg</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; InputM ()) -&gt; String -&gt; InputM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;input bytes: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366845"><span class="hs-identifier hs-var">stringRep</span></a></span><span>
</span><span id="line-143"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; InputM String
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366845"><span class="hs-identifier hs-var">stringRep</span></a></span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#applyConfig"><span class="hs-identifier hs-type">applyConfig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Fd</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Graphics.Vty.Config.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span id="applyConfig"><span class="annot"><span class="annottext">applyConfig :: Fd -&gt; Config -&gt; IO ()
</span><a href="Graphics.Vty.Input.Loop.html#applyConfig"><span class="hs-identifier hs-var hs-var">applyConfig</span></a></span></span><span> </span><span id="local-6989586621679366838"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679366838"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Graphics.Vty.Config.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">vmin :: Config -&gt; Maybe Int
</span><a href="Graphics.Vty.Config.html#vmin"><span class="hs-identifier hs-var">vmin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679366835"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679366835"><span class="hs-identifier hs-var">theVmin</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">vtime :: Config -&gt; Maybe Int
</span><a href="Graphics.Vty.Config.html#vtime"><span class="hs-identifier hs-var">vtime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679366833"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679366833"><span class="hs-identifier hs-var">theVtime</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fd -&gt; Int -&gt; Int -&gt; IO ()
</span><a href="Graphics.Vty.Input.Loop.html#setTermTiming"><span class="hs-identifier hs-var">setTermTiming</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679366838"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679366835"><span class="hs-identifier hs-var">theVmin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679366833"><span class="hs-identifier hs-var">theVtime</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">100</span></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#applyConfig"><span class="hs-identifier hs-var">applyConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Config
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(vty) applyConfig was not provided a complete configuration&quot;</span></span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#parseEvent"><span class="hs-identifier hs-type">parseEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#InputM"><span class="hs-identifier hs-type">InputM</span></a></span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Events.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span>
</span><span id="line-151"></span><span id="parseEvent"><span class="annot"><span class="annottext">parseEvent :: StateT InputState (ReaderT Input IO) Event
</span><a href="Graphics.Vty.Input.Loop.html#parseEvent"><span class="hs-identifier hs-var hs-var">parseEvent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-152"></span><span>    </span><span id="local-6989586621679366830"><span class="annot"><span class="annottext">String -&gt; KClass
</span><a href="#local-6989586621679366830"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Getting (String -&gt; KClass) InputState (String -&gt; KClass)
-&gt; StateT InputState (ReaderT Input IO) (String -&gt; KClass)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">use</span></span><span> </span><span class="annot"><span class="annottext">Getting (String -&gt; KClass) InputState (String -&gt; KClass)
Lens' InputState (String -&gt; KClass)
</span><a href="Graphics.Vty.Input.Loop.html#classifier"><span class="hs-identifier hs-var">classifier</span></a></span><span>
</span><span id="line-153"></span><span>    </span><span id="local-6989586621679366829"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366829"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Getting String InputState String -&gt; InputM String
forall s (m :: * -&gt; *) a. MonadState s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">use</span></span><span> </span><span class="annot"><span class="annottext">Getting String InputState String
Lens' InputState String
</span><a href="Graphics.Vty.Input.Loop.html#unprocessedBytes"><span class="hs-identifier hs-var">unprocessedBytes</span></a></span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">String -&gt; KClass
</span><a href="#local-6989586621679366830"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366829"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-155"></span><span>        </span><span class="annot"><a href="Graphics.Vty.Input.Classify.Types.html#Valid"><span class="hs-identifier hs-type">Valid</span></a></span><span> </span><span id="local-6989586621679366827"><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679366827"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621679366826"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366826"><span class="hs-identifier hs-var">remaining</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-156"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; InputM ()
</span><a href="Graphics.Vty.Input.Loop.html#logMsg"><span class="hs-identifier hs-var">logMsg</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; InputM ()) -&gt; String -&gt; InputM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;valid parse: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Event -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679366827"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-157"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; InputM ()
</span><a href="Graphics.Vty.Input.Loop.html#logMsg"><span class="hs-identifier hs-var">logMsg</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; InputM ()) -&gt; String -&gt; InputM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;remaining: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366826"><span class="hs-identifier hs-var">remaining</span></a></span><span>
</span><span id="line-158"></span><span>            </span><span class="annot"><span class="annottext">(String -&gt; Identity String) -&gt; InputState -&gt; Identity InputState
Lens' InputState String
</span><a href="Graphics.Vty.Input.Loop.html#unprocessedBytes"><span class="hs-identifier hs-var">unprocessedBytes</span></a></span><span> </span><span class="annot"><span class="annottext">((String -&gt; Identity String) -&gt; InputState -&gt; Identity InputState)
-&gt; String -&gt; InputM ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366826"><span class="hs-identifier hs-var">remaining</span></a></span><span>
</span><span id="line-159"></span><span>            </span><span class="annot"><span class="annottext">Event -&gt; StateT InputState (ReaderT Input IO) Event
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679366827"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-160"></span><span>        </span><span class="annot"><span class="annottext">KClass
</span><span class="hs-identifier">_</span></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StateT InputState (ReaderT Input IO) Event
forall (m :: * -&gt; *) a. MonadPlus m =&gt; m a
</span><span class="hs-identifier hs-var">mzero</span></span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#dropInvalid"><span class="hs-identifier hs-type">dropInvalid</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#InputM"><span class="hs-identifier hs-type">InputM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span id="dropInvalid"><span class="annot"><span class="annottext">dropInvalid :: InputM ()
</span><a href="Graphics.Vty.Input.Loop.html#dropInvalid"><span class="hs-identifier hs-var hs-var">dropInvalid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-164"></span><span>    </span><span id="local-6989586621679366825"><span class="annot"><span class="annottext">String -&gt; KClass
</span><a href="#local-6989586621679366825"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Getting (String -&gt; KClass) InputState (String -&gt; KClass)
-&gt; StateT InputState (ReaderT Input IO) (String -&gt; KClass)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">use</span></span><span> </span><span class="annot"><span class="annottext">Getting (String -&gt; KClass) InputState (String -&gt; KClass)
Lens' InputState (String -&gt; KClass)
</span><a href="Graphics.Vty.Input.Loop.html#classifier"><span class="hs-identifier hs-var">classifier</span></a></span><span>
</span><span id="line-165"></span><span>    </span><span id="local-6989586621679366824"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366824"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Getting String InputState String -&gt; InputM String
forall s (m :: * -&gt; *) a. MonadState s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">use</span></span><span> </span><span class="annot"><span class="annottext">Getting String InputState String
Lens' InputState String
</span><a href="Graphics.Vty.Input.Loop.html#unprocessedBytes"><span class="hs-identifier hs-var">unprocessedBytes</span></a></span><span>
</span><span id="line-166"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; InputM () -&gt; InputM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; KClass
</span><a href="#local-6989586621679366825"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366824"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">KClass -&gt; KClass -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">KClass
</span><a href="Graphics.Vty.Input.Classify.Types.html#Invalid"><span class="hs-identifier hs-var">Invalid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InputM () -&gt; InputM ()) -&gt; InputM () -&gt; InputM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-167"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; InputM ()
</span><a href="Graphics.Vty.Input.Loop.html#logMsg"><span class="hs-identifier hs-var">logMsg</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dropping input bytes&quot;</span></span><span>
</span><span id="line-168"></span><span>        </span><span class="annot"><span class="annottext">(String -&gt; Identity String) -&gt; InputState -&gt; Identity InputState
Lens' InputState String
</span><a href="Graphics.Vty.Input.Loop.html#unprocessedBytes"><span class="hs-identifier hs-var">unprocessedBytes</span></a></span><span> </span><span class="annot"><span class="annottext">((String -&gt; Identity String) -&gt; InputState -&gt; Identity InputState)
-&gt; String -&gt; InputM ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#runInputProcessorLoop"><span class="hs-identifier hs-type">runInputProcessorLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Events.html#ClassifyMap"><span class="hs-identifier hs-type">ClassifyMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#Input"><span class="hs-identifier hs-type">Input</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span id="runInputProcessorLoop"><span class="annot"><span class="annottext">runInputProcessorLoop :: ClassifyMap -&gt; Input -&gt; IO ()
</span><a href="Graphics.Vty.Input.Loop.html#runInputProcessorLoop"><span class="hs-identifier hs-var hs-var">runInputProcessorLoop</span></a></span></span><span> </span><span id="local-6989586621679366821"><span class="annot"><span class="annottext">ClassifyMap
</span><a href="#local-6989586621679366821"><span class="hs-identifier hs-var">classifyTable</span></a></span></span><span> </span><span id="local-6989586621679366820"><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621679366820"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679366819"><span class="annot"><span class="annottext">bufferSize :: p
</span><a href="#local-6989586621679366819"><span class="hs-identifier hs-var hs-var">bufferSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-number">1024</span></span><span>
</span><span id="line-173"></span><span>    </span><span class="annot"><span class="annottext">Int -&gt; (Ptr Word8 -&gt; IO ()) -&gt; IO ()
forall a b. Storable a =&gt; Int -&gt; (Ptr a -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">allocaArray</span></span><span> </span><span class="annot"><span class="annottext">Int
forall p. Num p =&gt; p
</span><a href="#local-6989586621679366819"><span class="hs-identifier hs-var">bufferSize</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr Word8 -&gt; IO ()) -&gt; IO ()) -&gt; (Ptr Word8 -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679366818"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679366818"><span class="hs-identifier hs-var">bufferPtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-174"></span><span>        </span><span id="local-6989586621679366817"><span class="annot"><span class="annottext">InputState
</span><a href="#local-6989586621679366817"><span class="hs-identifier hs-var">s0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Config -&gt; InputBuffer -&gt; (String -&gt; KClass) -&gt; InputState
</span><a href="Graphics.Vty.Input.Loop.html#InputState"><span class="hs-identifier hs-var">InputState</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Config -&gt; InputBuffer -&gt; (String -&gt; KClass) -&gt; InputState)
-&gt; IO Config
-&gt; IO (InputBuffer -&gt; (String -&gt; KClass) -&gt; InputState)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef Config -&gt; IO Config
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Input -&gt; IORef Config
</span><a href="Graphics.Vty.Input.Loop.html#_configRef"><span class="hs-identifier hs-var hs-var">_configRef</span></a></span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621679366820"><span class="hs-identifier hs-var">input</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>                            </span><span class="annot"><span class="annottext">IO (InputBuffer -&gt; (String -&gt; KClass) -&gt; InputState)
-&gt; IO InputBuffer -&gt; IO ((String -&gt; KClass) -&gt; InputState)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">InputBuffer -&gt; IO InputBuffer
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; InputBuffer
</span><a href="Graphics.Vty.Input.Loop.html#InputBuffer"><span class="hs-identifier hs-var">InputBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679366818"><span class="hs-identifier hs-var">bufferPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
forall p. Num p =&gt; p
</span><a href="#local-6989586621679366819"><span class="hs-identifier hs-var">bufferSize</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>                            </span><span class="annot"><span class="annottext">IO ((String -&gt; KClass) -&gt; InputState)
-&gt; IO (String -&gt; KClass) -&gt; IO InputState
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; KClass) -&gt; IO (String -&gt; KClass)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClassifyMap -&gt; String -&gt; KClass
</span><a href="Graphics.Vty.Input.Classify.html#classify"><span class="hs-identifier hs-var">classify</span></a></span><span> </span><span class="annot"><span class="annottext">ClassifyMap
</span><a href="#local-6989586621679366821"><span class="hs-identifier hs-var">classifyTable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>        </span><span class="annot"><span class="annottext">ReaderT Input IO () -&gt; Input -&gt; IO ()
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InputM () -&gt; InputState -&gt; ReaderT Input IO ()
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><span class="hs-identifier hs-var">evalStateT</span></span><span> </span><span class="annot"><span class="annottext">InputM ()
</span><a href="Graphics.Vty.Input.Loop.html#loopInputProcessor"><span class="hs-identifier hs-var">loopInputProcessor</span></a></span><span> </span><span class="annot"><span class="annottext">InputState
</span><a href="#local-6989586621679366817"><span class="hs-identifier hs-var">s0</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621679366820"><span class="hs-identifier hs-var">input</span></a></span><span>
</span><span id="line-178"></span><span>
</span><span id="line-179"></span><span class="hs-comment">-- | Construct two IO actions: one to configure the terminal for Vty and</span><span>
</span><span id="line-180"></span><span class="hs-comment">-- one to restore the terminal mode flags to the values they had at the</span><span>
</span><span id="line-181"></span><span class="hs-comment">-- time this function was called.</span><span>
</span><span id="line-182"></span><span class="hs-comment">--</span><span>
</span><span id="line-183"></span><span class="hs-comment">-- This function constructs a configuration action to clear the</span><span>
</span><span id="line-184"></span><span class="hs-comment">-- following terminal mode flags:</span><span>
</span><span id="line-185"></span><span class="hs-comment">--</span><span>
</span><span id="line-186"></span><span class="hs-comment">-- * IXON disabled: disables software flow control on outgoing data.</span><span>
</span><span id="line-187"></span><span class="hs-comment">-- This stops the process from being suspended if the output terminal</span><span>
</span><span id="line-188"></span><span class="hs-comment">-- cannot keep up.</span><span>
</span><span id="line-189"></span><span class="hs-comment">--</span><span>
</span><span id="line-190"></span><span class="hs-comment">-- * Raw mode is used for input.</span><span>
</span><span id="line-191"></span><span class="hs-comment">--</span><span>
</span><span id="line-192"></span><span class="hs-comment">-- * ISIG (enables keyboard combinations that result in</span><span>
</span><span id="line-193"></span><span class="hs-comment">-- signals)</span><span>
</span><span id="line-194"></span><span class="hs-comment">--</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- * ECHO (input is not echoed to the output)</span><span>
</span><span id="line-196"></span><span class="hs-comment">--</span><span>
</span><span id="line-197"></span><span class="hs-comment">-- * ICANON (canonical mode (line mode) input is not used)</span><span>
</span><span id="line-198"></span><span class="hs-comment">--</span><span>
</span><span id="line-199"></span><span class="hs-comment">-- * IEXTEN (extended functions are disabled)</span><span>
</span><span id="line-200"></span><span class="hs-comment">--</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- The configuration action also explicitly sets these flags:</span><span>
</span><span id="line-202"></span><span class="hs-comment">--</span><span>
</span><span id="line-203"></span><span class="hs-comment">-- * ICRNL (input carriage returns are mapped to newlines)</span><span>
</span><span id="line-204"></span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#attributeControl"><span class="hs-identifier hs-type">attributeControl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Fd</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span id="attributeControl"><span class="annot"><span class="annottext">attributeControl :: Fd -&gt; IO (IO (), IO ())
</span><a href="Graphics.Vty.Input.Loop.html#attributeControl"><span class="hs-identifier hs-var hs-var">attributeControl</span></a></span></span><span> </span><span id="local-6989586621679366812"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679366812"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-206"></span><span>    </span><span id="local-6989586621679366811"><span class="annot"><span class="annottext">TerminalAttributes
</span><a href="#local-6989586621679366811"><span class="hs-identifier hs-var">original</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Fd -&gt; IO TerminalAttributes
</span><span class="hs-identifier hs-var">getTerminalAttributes</span></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679366812"><span class="hs-identifier hs-var">fd</span></a></span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679366809"><span class="annot"><span class="annottext">vtyMode :: TerminalAttributes
</span><a href="#local-6989586621679366809"><span class="hs-identifier hs-var hs-var">vtyMode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TerminalAttributes -&gt; TerminalMode -&gt; TerminalAttributes)
-&gt; TerminalAttributes -&gt; [TerminalMode] -&gt; TerminalAttributes
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">TerminalAttributes -&gt; TerminalMode -&gt; TerminalAttributes
</span><span class="hs-identifier hs-var">withMode</span></span><span> </span><span class="annot"><span class="annottext">TerminalAttributes
</span><a href="#local-6989586621679366806"><span class="hs-identifier hs-var">clearedFlags</span></a></span><span> </span><span class="annot"><span class="annottext">[TerminalMode]
</span><a href="#local-6989586621679366805"><span class="hs-identifier hs-var">flagsToSet</span></a></span><span>
</span><span id="line-208"></span><span>        </span><span id="local-6989586621679366806"><span class="annot"><span class="annottext">clearedFlags :: TerminalAttributes
</span><a href="#local-6989586621679366806"><span class="hs-identifier hs-var hs-var">clearedFlags</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TerminalAttributes -&gt; TerminalMode -&gt; TerminalAttributes)
-&gt; TerminalAttributes -&gt; [TerminalMode] -&gt; TerminalAttributes
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">TerminalAttributes -&gt; TerminalMode -&gt; TerminalAttributes
</span><span class="hs-identifier hs-var">withoutMode</span></span><span> </span><span class="annot"><span class="annottext">TerminalAttributes
</span><a href="#local-6989586621679366811"><span class="hs-identifier hs-var">original</span></a></span><span> </span><span class="annot"><span class="annottext">[TerminalMode]
</span><a href="#local-6989586621679366803"><span class="hs-identifier hs-var">flagsToUnset</span></a></span><span>
</span><span id="line-209"></span><span>        </span><span id="local-6989586621679366805"><span class="annot"><span class="annottext">flagsToSet :: [TerminalMode]
</span><a href="#local-6989586621679366805"><span class="hs-identifier hs-var hs-var">flagsToSet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TerminalMode
</span><span class="hs-identifier hs-var">MapCRtoLF</span></span><span> </span><span class="hs-comment">-- ICRNL</span><span>
</span><span id="line-210"></span><span>                     </span><span class="hs-special">]</span><span>
</span><span id="line-211"></span><span>        </span><span id="local-6989586621679366803"><span class="annot"><span class="annottext">flagsToUnset :: [TerminalMode]
</span><a href="#local-6989586621679366803"><span class="hs-identifier hs-var hs-var">flagsToUnset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TerminalMode
</span><span class="hs-identifier hs-var">StartStopOutput</span></span><span> </span><span class="hs-comment">-- IXON</span><span>
</span><span id="line-212"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TerminalMode
</span><span class="hs-identifier hs-var">KeyboardInterrupts</span></span><span> </span><span class="hs-comment">-- ISIG</span><span>
</span><span id="line-213"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TerminalMode
</span><span class="hs-identifier hs-var">EnableEcho</span></span><span> </span><span class="hs-comment">-- ECHO</span><span>
</span><span id="line-214"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TerminalMode
</span><span class="hs-identifier hs-var">ProcessInput</span></span><span> </span><span class="hs-comment">-- ICANON</span><span>
</span><span id="line-215"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TerminalMode
</span><span class="hs-identifier hs-var">ExtendedFunctions</span></span><span> </span><span class="hs-comment">-- IEXTEN</span><span>
</span><span id="line-216"></span><span>                       </span><span class="hs-special">]</span><span>
</span><span id="line-217"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679366796"><span class="annot"><span class="annottext">setAttrs :: IO ()
</span><a href="#local-6989586621679366796"><span class="hs-identifier hs-var hs-var">setAttrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fd -&gt; TerminalAttributes -&gt; TerminalState -&gt; IO ()
</span><span class="hs-identifier hs-var">setTerminalAttributes</span></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679366812"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">TerminalAttributes
</span><a href="#local-6989586621679366809"><span class="hs-identifier hs-var">vtyMode</span></a></span><span> </span><span class="annot"><span class="annottext">TerminalState
</span><span class="hs-identifier hs-var">Immediately</span></span><span>
</span><span id="line-218"></span><span>        </span><span id="local-6989586621679366793"><span class="annot"><span class="annottext">unsetAttrs :: IO ()
</span><a href="#local-6989586621679366793"><span class="hs-identifier hs-var hs-var">unsetAttrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fd -&gt; TerminalAttributes -&gt; TerminalState -&gt; IO ()
</span><span class="hs-identifier hs-var">setTerminalAttributes</span></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679366812"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">TerminalAttributes
</span><a href="#local-6989586621679366811"><span class="hs-identifier hs-var">original</span></a></span><span> </span><span class="annot"><span class="annottext">TerminalState
</span><span class="hs-identifier hs-var">Immediately</span></span><span>
</span><span id="line-219"></span><span>    </span><span class="annot"><span class="annottext">(IO (), IO ()) -&gt; IO (IO (), IO ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679366796"><span class="hs-identifier hs-var">setAttrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679366793"><span class="hs-identifier hs-var">unsetAttrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#logInitialInputState"><span class="hs-identifier hs-type">logInitialInputState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#Input"><span class="hs-identifier hs-type">Input</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Events.html#ClassifyMap"><span class="hs-identifier hs-type">ClassifyMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span id="logInitialInputState"><span class="annot"><span class="annottext">logInitialInputState :: Input -&gt; ClassifyMap -&gt; IO ()
</span><a href="Graphics.Vty.Input.Loop.html#logInitialInputState"><span class="hs-identifier hs-var hs-var">logInitialInputState</span></a></span></span><span> </span><span id="local-6989586621679366791"><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621679366791"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span id="local-6989586621679366790"><span class="annot"><span class="annottext">ClassifyMap
</span><a href="#local-6989586621679366790"><span class="hs-identifier hs-var">classifyTable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Input -&gt; Maybe Handle
</span><a href="Graphics.Vty.Input.Loop.html#_inputDebug"><span class="hs-identifier hs-var hs-var">_inputDebug</span></a></span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621679366791"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-223"></span><span>    </span><span class="annot"><span class="annottext">Maybe Handle
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679366789"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679366789"><span class="hs-identifier hs-var">h</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-225"></span><span>        </span><span class="annot"><a href="Graphics.Vty.Config.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">vmin :: Config -&gt; Maybe Int
</span><a href="Graphics.Vty.Config.html#vmin"><span class="hs-identifier hs-var">vmin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679366788"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679366788"><span class="hs-identifier hs-var">theVmin</span></a></span></span><span>
</span><span id="line-226"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">vtime :: Config -&gt; Maybe Int
</span><a href="Graphics.Vty.Config.html#vtime"><span class="hs-identifier hs-var">vtime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679366787"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679366787"><span class="hs-identifier hs-var">theVtime</span></a></span></span><span>
</span><span id="line-227"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">termName :: Config -&gt; Maybe String
</span><a href="Graphics.Vty.Config.html#termName"><span class="hs-identifier hs-var">termName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679366785"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366785"><span class="hs-identifier hs-var">theTerm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679366777"><span id="local-6989586621679366778"><span id="local-6989586621679366779"><span id="local-6989586621679366780"><span id="local-6989586621679366781"><span id="local-6989586621679366782"><span id="local-6989586621679366783"><span id="local-6989586621679366784"><span class="annot"><span class="annottext">[(String, String)]
InputMap
Maybe Bool
Maybe String
Maybe Fd
allowCustomUnicodeWidthTables :: Config -&gt; Maybe Bool
termWidthMaps :: Config -&gt; [(String, String)]
outputFd :: Config -&gt; Maybe Fd
inputMap :: Config -&gt; InputMap
debugLog :: Config -&gt; Maybe String
bracketedPasteMode :: Config -&gt; Maybe Bool
mouseMode :: Config -&gt; Maybe Bool
allowCustomUnicodeWidthTables :: Maybe Bool
termWidthMaps :: [(String, String)]
outputFd :: Maybe Fd
inputFd :: Maybe Fd
inputMap :: InputMap
debugLog :: Maybe String
bracketedPasteMode :: Maybe Bool
mouseMode :: Maybe Bool
inputFd :: Config -&gt; Maybe Fd
</span><a href="Graphics.Vty.Config.html#allowCustomUnicodeWidthTables"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Config -&gt; IO Config
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef Config -&gt; IO Config) -&gt; IORef Config -&gt; IO Config
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Input -&gt; IORef Config
</span><a href="Graphics.Vty.Input.Loop.html#_configRef"><span class="hs-identifier hs-var hs-var">_configRef</span></a></span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621679366791"><span class="hs-identifier hs-var">input</span></a></span><span>
</span><span id="line-228"></span><span>        </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Handle -&gt; String -&gt; String -&gt; IO ()
forall r. HPrintfType r =&gt; Handle -&gt; String -&gt; r
</span><span class="hs-identifier hs-var">hPrintf</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679366789"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;initial (vmin,vtime): %s\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int, Int) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679366788"><span class="hs-identifier hs-var">theVmin</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679366787"><span class="hs-identifier hs-var">theVtime</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>        </span><span class="annot"><span class="annottext">ClassifyMap -&gt; ((String, Event) -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">ClassifyMap
</span><a href="#local-6989586621679366790"><span class="hs-identifier hs-var">classifyTable</span></a></span><span> </span><span class="annot"><span class="annottext">(((String, Event) -&gt; IO ()) -&gt; IO ())
-&gt; ((String, Event) -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679366769"><span class="annot"><span class="annottext">(String, Event)
</span><a href="#local-6989586621679366769"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(String, Event)
</span><a href="#local-6989586621679366769"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-230"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679366768"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366768"><span class="hs-identifier hs-var">inBytes</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Events.html#EvKey"><span class="hs-identifier hs-type">EvKey</span></a></span><span> </span><span id="local-6989586621679366766"><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621679366766"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679366765"><span class="annot"><span class="annottext">[Modifier]
</span><a href="#local-6989586621679366765"><span class="hs-identifier hs-var">mods</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Handle -&gt; String -&gt; String -&gt; String -&gt; String -&gt; String -&gt; IO ()
forall r. HPrintfType r =&gt; Handle -&gt; String -&gt; r
</span><span class="hs-identifier hs-var">hPrintf</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679366789"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;map %s %s %s %s\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366785"><span class="hs-identifier hs-var">theTerm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>                                                                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366768"><span class="hs-identifier hs-var">inBytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>                                                                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Key -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621679366766"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>                                                                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Modifier] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[Modifier]
</span><a href="#local-6989586621679366765"><span class="hs-identifier hs-var">mods</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>            </span><span class="annot"><span class="annottext">(String, Event)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#initInput"><span class="hs-identifier hs-type">initInput</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Graphics.Vty.Config.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Events.html#ClassifyMap"><span class="hs-identifier hs-type">ClassifyMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Graphics.Vty.Input.Loop.html#Input"><span class="hs-identifier hs-type">Input</span></a></span><span>
</span><span id="line-237"></span><span id="initInput"><span class="annot"><span class="annottext">initInput :: Config -&gt; ClassifyMap -&gt; IO Input
</span><a href="Graphics.Vty.Input.Loop.html#initInput"><span class="hs-identifier hs-var hs-var">initInput</span></a></span></span><span> </span><span id="local-6989586621679366763"><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679366763"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span id="local-6989586621679366762"><span class="annot"><span class="annottext">ClassifyMap
</span><a href="#local-6989586621679366762"><span class="hs-identifier hs-var">classifyTable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-238"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679366761"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679366761"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config -&gt; Maybe Fd
</span><a href="Graphics.Vty.Config.html#inputFd"><span class="hs-identifier hs-var hs-var">inputFd</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679366763"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-239"></span><span>    </span><span class="annot"><span class="annottext">Fd -&gt; FdOption -&gt; Bool -&gt; IO ()
</span><span class="hs-identifier hs-var">setFdOption</span></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679366761"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">FdOption
</span><span class="hs-identifier hs-var">NonBlockingRead</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-240"></span><span>    </span><span class="annot"><span class="annottext">Fd -&gt; Config -&gt; IO ()
</span><a href="Graphics.Vty.Input.Loop.html#applyConfig"><span class="hs-identifier hs-var">applyConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679366761"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679366763"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-241"></span><span>    </span><span id="local-6989586621679366759"><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621679366759"><span class="hs-identifier hs-var">stopSync</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (MVar ())
forall a. IO (MVar a)
</span><span class="hs-identifier hs-var">newEmptyMVar</span></span><span>
</span><span id="line-242"></span><span>    </span><span id="local-6989586621679366757"><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621679366757"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TChan Event
-&gt; IO () -&gt; IO () -&gt; IORef Config -&gt; Maybe Handle -&gt; Input
</span><a href="Graphics.Vty.Input.Loop.html#Input"><span class="hs-identifier hs-var">Input</span></a></span><span> </span><span class="annot"><span class="annottext">(TChan Event
 -&gt; IO () -&gt; IO () -&gt; IORef Config -&gt; Maybe Handle -&gt; Input)
-&gt; IO (TChan Event)
-&gt; IO (IO () -&gt; IO () -&gt; IORef Config -&gt; Maybe Handle -&gt; Input)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM (TChan Event) -&gt; IO (TChan Event)
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">STM (TChan Event)
forall a. STM (TChan a)
</span><span class="hs-identifier hs-var">newTChan</span></span><span>
</span><span id="line-243"></span><span>                   </span><span class="annot"><span class="annottext">IO (IO () -&gt; IO () -&gt; IORef Config -&gt; Maybe Handle -&gt; Input)
-&gt; IO (IO ())
-&gt; IO (IO () -&gt; IORef Config -&gt; Maybe Handle -&gt; Input)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (IO ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span>                   </span><span class="annot"><span class="annottext">IO (IO () -&gt; IORef Config -&gt; Maybe Handle -&gt; Input)
-&gt; IO (IO ()) -&gt; IO (IORef Config -&gt; Maybe Handle -&gt; Input)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (IO ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>                   </span><span class="annot"><span class="annottext">IO (IORef Config -&gt; Maybe Handle -&gt; Input)
-&gt; IO (IORef Config) -&gt; IO (Maybe Handle -&gt; Input)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Config -&gt; IO (IORef Config)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679366763"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-246"></span><span>                   </span><span class="annot"><span class="annottext">IO (Maybe Handle -&gt; Input) -&gt; IO (Maybe Handle) -&gt; IO Input
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO (Maybe Handle)
-&gt; (String -&gt; IO (Maybe Handle))
-&gt; Maybe String
-&gt; IO (Maybe Handle)
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Handle -&gt; IO (Maybe Handle)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Handle
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>                             </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679366753"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366753"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Handle -&gt; Maybe Handle
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Handle -&gt; Maybe Handle) -&gt; IO Handle -&gt; IO (Maybe Handle)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IOMode -&gt; IO Handle
</span><span class="hs-identifier hs-var">openFile</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679366753"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">IOMode
</span><span class="hs-identifier hs-var">AppendMode</span></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Config -&gt; Maybe String
</span><a href="Graphics.Vty.Config.html#debugLog"><span class="hs-identifier hs-var hs-var">debugLog</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679366763"><span class="hs-identifier hs-var">config</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>    </span><span class="annot"><span class="annottext">Input -&gt; ClassifyMap -&gt; IO ()
</span><a href="Graphics.Vty.Input.Loop.html#logInitialInputState"><span class="hs-identifier hs-var">logInitialInputState</span></a></span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621679366757"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="annot"><span class="annottext">ClassifyMap
</span><a href="#local-6989586621679366762"><span class="hs-identifier hs-var">classifyTable</span></a></span><span>
</span><span id="line-250"></span><span>    </span><span id="local-6989586621679366750"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679366750"><span class="hs-identifier hs-var">inputThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; (Either SomeException () -&gt; IO ()) -&gt; IO ThreadId
forall a. IO a -&gt; (Either SomeException a -&gt; IO ()) -&gt; IO ThreadId
</span><a href="Graphics.Vty.Input.Loop.html#forkOSFinally"><span class="hs-identifier hs-var">forkOSFinally</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClassifyMap -&gt; Input -&gt; IO ()
</span><a href="Graphics.Vty.Input.Loop.html#runInputProcessorLoop"><span class="hs-identifier hs-var">runInputProcessorLoop</span></a></span><span> </span><span class="annot"><span class="annottext">ClassifyMap
</span><a href="#local-6989586621679366762"><span class="hs-identifier hs-var">classifyTable</span></a></span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621679366757"><span class="hs-identifier hs-var">input</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>                                 </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Either SomeException ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MVar () -&gt; () -&gt; IO ()
forall a. MVar a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">putMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621679366759"><span class="hs-identifier hs-var">stopSync</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679366747"><span class="annot"><span class="annottext">killAndWait :: IO ()
</span><a href="#local-6989586621679366747"><span class="hs-identifier hs-var hs-var">killAndWait</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-253"></span><span>          </span><span class="annot"><span class="annottext">ThreadId -&gt; IO ()
</span><span class="hs-identifier hs-var">killThread</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679366750"><span class="hs-identifier hs-var">inputThread</span></a></span><span>
</span><span id="line-254"></span><span>          </span><span class="annot"><span class="annottext">MVar () -&gt; IO ()
forall a. MVar a -&gt; IO a
</span><span class="hs-identifier hs-var">takeMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621679366759"><span class="hs-identifier hs-var">stopSync</span></a></span><span>
</span><span id="line-255"></span><span>    </span><span class="annot"><span class="annottext">Input -&gt; IO Input
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Input -&gt; IO Input) -&gt; Input -&gt; IO Input
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621679366757"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">shutdownInput :: IO ()
</span><a href="Graphics.Vty.Input.Loop.html#shutdownInput"><span class="hs-identifier hs-var">shutdownInput</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679366747"><span class="hs-identifier hs-var">killAndWait</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-keyword">ccall</span></span><span> </span><span class="annot"><span class="hs-string">&quot;vty_set_term_timing&quot;</span></span><span> </span><span id="setTermTiming"><span class="annot"><a href="Graphics.Vty.Input.Loop.html#setTermTiming"><span class="hs-identifier hs-var">setTermTiming</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Fd</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span id="local-6989586621679366943"><span class="annot"><a href="Graphics.Vty.Input.Loop.html#forkOSFinally"><span class="hs-identifier hs-type">forkOSFinally</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679366943"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="annot"><a href="#local-6989586621679366943"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span></span><span>
</span><span id="line-260"></span><span id="forkOSFinally"><span class="annot"><span class="annottext">forkOSFinally :: IO a -&gt; (Either SomeException a -&gt; IO ()) -&gt; IO ThreadId
</span><a href="Graphics.Vty.Input.Loop.html#forkOSFinally"><span class="hs-identifier hs-var hs-var">forkOSFinally</span></a></span></span><span> </span><span id="local-6989586621679366744"><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679366744"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span id="local-6989586621679366743"><span class="annot"><span class="annottext">Either SomeException a -&gt; IO ()
</span><a href="#local-6989586621679366743"><span class="hs-identifier hs-var">and_then</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-261"></span><span>  </span><span class="annot"><span class="annottext">((forall a. IO a -&gt; IO a) -&gt; IO ThreadId) -&gt; IO ThreadId
forall b. ((forall a. IO a -&gt; IO a) -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">mask</span></span><span> </span><span class="annot"><span class="annottext">(((forall a. IO a -&gt; IO a) -&gt; IO ThreadId) -&gt; IO ThreadId)
-&gt; ((forall a. IO a -&gt; IO a) -&gt; IO ThreadId) -&gt; IO ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679366742"><span class="annot"><span class="annottext">forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679366742"><span class="hs-identifier hs-var">restore</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><span class="hs-identifier hs-var">forkOS</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ThreadId) -&gt; IO () -&gt; IO ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO (Either SomeException a)
forall e a. Exception e =&gt; IO a -&gt; IO (Either e a)
</span><span class="hs-identifier hs-var">try</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO a -&gt; IO a
forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679366742"><span class="hs-identifier hs-var">restore</span></a></span><span> </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679366744"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO (Either SomeException a)
-&gt; (Either SomeException a -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Either SomeException a -&gt; IO ()
</span><a href="#local-6989586621679366743"><span class="hs-identifier hs-var">and_then</span></a></span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span id="local-6989586621679367026"><span id="local-6989586621679367028"><span id="local-6989586621679367029"><span class="annot"><a href="Graphics.Vty.Input.Loop.html#%3C%3E%3D"><span class="hs-operator hs-type">(&lt;&gt;=)</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="#local-6989586621679367029"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679367028"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621679367026"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ASetter'</span></span><span> </span><span class="annot"><a href="#local-6989586621679367029"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679367026"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679367026"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679367028"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-264"></span><span id="local-6989586621679366740"><span class="annot"><span class="annottext">ASetter' s a
</span><a href="#local-6989586621679366740"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="%3C%3E%3D"><span class="annot"><span class="annottext">&lt;&gt;= :: ASetter' s a -&gt; a -&gt; m ()
</span><a href="Graphics.Vty.Input.Loop.html#%3C%3E%3D"><span class="hs-operator hs-var hs-var">&lt;&gt;=</span></a></span></span><span> </span><span id="local-6989586621679366739"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679366739"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(s -&gt; s) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ASetter' s a
</span><a href="#local-6989586621679366740"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter' s a -&gt; a -&gt; s -&gt; s
forall a s t. Monoid a =&gt; ASetter s t a a -&gt; a -&gt; s -&gt; t
</span><a href="Graphics.Vty.Input.Loop.html#%3C%3E~"><span class="hs-operator hs-var">&lt;&gt;~</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679366739"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span id="local-6989586621679366927"><span id="local-6989586621679366928"><span id="local-6989586621679366929"><span class="annot"><a href="Graphics.Vty.Input.Loop.html#%3C%3E~"><span class="hs-operator hs-type">(&lt;&gt;~)</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621679366929"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ASetter</span></span><span> </span><span class="annot"><a href="#local-6989586621679366928"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679366927"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679366929"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679366929"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679366929"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679366928"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679366927"><span class="hs-identifier hs-type">t</span></a></span></span></span></span><span>
</span><span id="line-267"></span><span id="local-6989586621679366737"><span class="annot"><span class="annottext">ASetter s t a a
</span><a href="#local-6989586621679366737"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="%3C%3E~"><span class="annot"><span class="annottext">&lt;&gt;~ :: ASetter s t a a -&gt; a -&gt; s -&gt; t
</span><a href="Graphics.Vty.Input.Loop.html#%3C%3E~"><span class="hs-operator hs-var hs-var">&lt;&gt;~</span></a></span></span><span> </span><span id="local-6989586621679366736"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679366736"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ASetter s t a a -&gt; (a -&gt; a) -&gt; s -&gt; t
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">over</span></span><span> </span><span class="annot"><span class="annottext">ASetter s t a a
</span><a href="#local-6989586621679366737"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Monoid a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mappend`</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679366736"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span></pre></body></html>